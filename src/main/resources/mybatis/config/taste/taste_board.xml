<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tasteBoard">
	<resultMap type="article" id="articleRM">
	    <result property="restaurant.resNo" column="resno"/>
	    <result property="restaurant.city" column="rcity"/>
	    <result property="restaurant.sigungu" column="rsigungu"/>
	    <result property="restaurant.eupmyeondong" column="reupmyeondong"/>
	    <result property="restaurant.resName" column="rname"/>
	    <result property="restaurant.good" column="rgood"/>
	    <result property="restaurant.bad" column="rbad"/>
		<result property="articleNo" column="article_no"/>
		<result property="regDate" column="reg_date"/>
		<result property="member.id" column="id"/>
		<result property="member.password" column="password"/>
		<result property="member.name" column="name"/>
		<result property="member.city" column="city"/>
		<result property="member.sigungu" column="sigungu"/>
		<result property="member.eupmyeondong" column="eupmyeondong"/>
		<result property="member.address" column="address"/>
		<result property="member.gender" column="gender"/>
		<result property="member.birth" column="birth"/>
		<result property="member.tel" column="tel"/>
		<result property="member.exp" column="exp"/>
		<result property="member.point" column="point"/>
		<result property="member.profileImg" column="profile_Img"/>
	</resultMap>
	<sql id="getArticle">
		select article_no,location,writer,title,contents,
		to_char(reg_date,'YYYY-MM-DD HH24:MI:SS')as reg_date,
		good,bad,hits from taste_board
	</sql>
	<select id="getTotalCount" resultType="int">
		select count(*) from taste_board
	</select>
	<select id="getDynamicTotalCount" resultType="int">
		select count(*) from taste_board
		<where>
			<choose>
				<when test="location!=null and location!=''">
					location=#{location}
				</when>
				<when test="writer!=null and writer!=''">
					writer=#{writer}
				</when>
				<otherwise>
					article_no=-1
				</otherwise>
			</choose>
		</where>
	</select>
	<insert id="insertArticle">
		<selectKey keyProperty="articleNo" keyColumn="article_no" resultType="int" order="BEFORE">
			select taste_board_sequence.nextval from dual
		</selectKey>
		insert into taste_board(article_no,writer,res_no,title,contents)
		values(taste_board_sequence.currval,#{writer},#{resNo},#{title},#{contents})
	</insert>
	<update id="updateArticle">
		update taste_board set title=#{title},contents=#{contents}
		where article_no=#{articleNo}
	</update>
	<delete id="deleteArticle">
		delete from taste_board where article_no=#{articleNo}
	</delete>
	<select id="getArticleByNo" resultMap="articleRM">
	    select rownum,t.*,m.*,r.res_no resno,r.city rcity,r.sigungu rsigungu,r.eupmyeondong reupmyeondong,r.res_name rname,r.good rgood,r.bad rbad from taste_board t, member m,restaurant r where t.writer=m.id and r.res_no=t.res_no and article_no=#{articleNo}
	</select>
	<select id="getArticles" resultMap="articleRM">
		select * from (
			select t.*, m.*
			from (select rownum as rnum,t.* from taste_board t order by article_no desc) t, member m
			where t.writer=m.id
		) where rnum between #{beginRow} and #{endRow} order by rnum asc
	</select>
	<select id="getArticlesOrderByHits" resultMap="articleRM">
		select * from (
			select rownum as rnum, t.*, m.*
			from (select * from taste_board order by hits desc) t, member m
			where t.writer=m.id
		) where rnum between #{beginRow} and #{endRow}
	</select>
	<select id="testGetArticlesOredrByRank" resultMap="articleRM">
		select * from (
			select rownum as rnum, t.*, m.*
			from (select * from taste_board order by good-bad desc) t, member m
			where t.writer=m.id
		) where rnum between #{beginRow} and #{endRow}
	</select>
	<select id="getArticlesByLocation" resultMap="articleRM">
		select * from (
			select rownum as rnum, t.*, m.*
			from (select * from taste_board where location=#{location} order by good-bad desc) t, member m
			where t.writer=m.id
		) where rnum between #{page.beginRow} and #{page.endRow}
	</select>
	<select id="getArticlesByWriter" resultMap="articleRM">
		select * from (
			select rownum as rnum, t.*, m.*
			from (select * from taste_board where writer=#{writer} order by good-bad desc) t, member m
			where t.writer=m.id
		) where rnum between #{page.beginRow} and #{page.endRow}
	</select>
	<update id="upHits">
		update taste_board set hits=hits+1 where article_no=#{articleNo}
	</update>
	<update id="upGood">
		update taste_board set good=good+1 where article_no=#{articleNo}
	</update>
	<update id="upBad">
		update taste_board set bad=bad+1 where article_no=#{articleNo}
	</update>
	<insert id="insertVote">
		insert into taste_board_vote(article_no,member_id) 
		values (#{articleNo},#{id})
	</insert>
	<select id="selectVotedList" resultType="string">
		select member_id from taste_board_vote where article_no=#{articleNo}
	</select>
	
	<select id="selectBoardByAddress" resultType="article">
	    select article_no articleno,m.name writer,title,contents from taste_board t,member m where city=#{city} and sigungu=#{sigungu} and eupmyeondong=#{eupmyeondong} and address=#{resName} and m.id=t.writer
	</select>
	
	<select id="selectBoardByResNo" resultType="article">
	   select a.* from (select rownum numrow,t.* from (select t.article_no articleno,m.name writer,t.title title,t.contents contents from taste_board t,member m  where res_no=#{resNo} and m.id=t.writer order by article_no desc)t)a where numrow between #{beginRow} and #{endRow}
	</select>
	
	<select id="selectTotalCntBoardByResNo" resultType="int">
	    select count(*) from taste_board where res_no=#{value}	    
	</select>
	
	<select id="selectByWriter" resultMap="articleRM">
	    select * from (
			select rownum as rnum, t.*, m.id,upper(m.name) name,m.password,m.city,m.sigungu,
			m.eupmyeondong,m.address,m.gender,m.birth,m.tel,m.exp,m.point,m.join_date,
			m.profile_img
			from (select * from taste_board) t, member m
			where t.writer=m.id
		)where name like upper('%' ||  #{value} || '%') order by article_no desc
	</select>
	
	<select id="selectByTitle" resultMap="articleRM">
	    select * from (
			select rownum as rnum, t.article_no,t.writer,upper(t.title) title,t.contents,t.reg_date,t.reply,
			t.good,t.bad,t.hits, m.id,m.name,m.password,m.city,m.sigungu,
			m.eupmyeondong,m.address,m.gender,m.birth,m.tel,m.exp,m.point,m.join_date,
			m.profile_img
			from (select * from taste_board) t, member m
			where t.writer=m.id
		)where title like upper('%' ||  #{value} || '%') order by article_no desc
	</select>
	
	<select id="selectByWriterApplicationPaging" resultMap="articleRM">
	    select * from (
			select rownum as rnum, t.*, m.id,upper(m.name) name,m.password,m.city,m.sigungu,
			m.eupmyeondong,m.address,m.gender,m.birth,m.tel,m.exp,m.point,m.join_date,
			m.profile_img
			from (select * from taste_board order by article_no desc) t, member m
			where t.writer=m.id and name like upper('%'|| #{name} ||'%')
		)  where rnum between #{beginRow} and #{endRow}
	</select>
	
	<select id="selectByTitleApplicationPaging" resultMap="articleRM">
	    select * from (
			select rownum as rnum, t.article_no,t.writer,upper(t.title) title,t.contents,t.reg_date,t.reply,
			t.good,t.bad,t.hits, m.id,m.name,m.password,m.city,m.sigungu,
			m.eupmyeondong,m.address,m.gender,m.birth,m.tel,m.exp,m.point,m.join_date,
			m.profile_img
			from (select * from taste_board order by article_no desc) t, member m
			where t.writer=m.id and title like upper('%'|| #{title} ||'%')
		)  where rnum between #{beginRow} and #{endRow}
	</select>
</mapper>
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
















